<!doctype html>
<html lang="th">
  <head>
    <title>Go Request: อย่าลืม ContentLength ถ้าไม่ได้กำหนด Body ด้วย NewRequest</title>
    <meta charset="utf-8" />
    <link type="text/css" rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Go Request: อย่าลืม ContentLength ถ้าไม่ได้กำหนด Body ด้วย NewRequest</h1>
    <p>ปกติเวลาเราต้องการยิง HTTP Request ด้วย Go เราสามารถใช้ package net/http ช่วยได้โดยใช้การสร้าง request ใหม่แล้วเรียกเมธอด Do แบบนี้</p>
    <pre><code>package main

import (
	&quot;io&quot;
	&quot;log&quot;
	&quot;net/http&quot;
	&quot;os&quot;
	&quot;strings&quot;
)

func main() {
	r, err := http.NewRequest(
			&quot;POST&quot;,
			&quot;https://httpbin.org/delay/1&quot;,
			strings.NewReader(`{&quot;say&quot;: &quot;Hello, World&quot;}`))
	if err != nil {
		log.Fatal(err)
	}
	resp, err := http.DefaultClient.Do(r)
	if err != nil {
		log.Fatal(err)
	}
	io.Copy(os.Stdout, resp.Body)
}</code></pre>
    <p>สิ่งที่ http.NewRequest ทำให้นอกจากจะกำหนดค่าให้ r.Body แล้วยังกำหนดค่า r.ContentLength ให้อีกด้วย โดยหาขนาดจาก body ที่เราส่งเข้าไป แต่ถ้าเกิดเราเรียก http.NewRequest โดยกำหนด body เป็น nil ไปแล้วล่ะก็ r.ContentLength ก็ยังคงเป็น 0</p>
    <p>ทีนี้เราสามารถกำหนดค่า r.Body เพิ่มเติมเข้าไปได้ แต่ว่าตอนนี้ต้อง wrap ด้วย ioutil.NopCloser เพราะ type ของ Body จริงๆแล้วคือ io.ReadCloser แต่ strings.Reader เป็นแค่ io.Reader เท่านั้น เช่น
    </p>
    <pre><code>r.Body = ioutil.NopCloser(strings.NewReader(`{&quot;say&quot;: &quot;Hello, World&quot;}`))</code></pre>
    <p>แต่เมื่อไหร่ก็ตามที่ request เรามี Body แต่ ContentLength เป็น 0 เวลาเรียก http.DefaultClient.Do(r) ไปจริงๆนั้นมันจะกำหนด header &quot;Content-Length: -1&quot; ออกไป</p>
    <p>การส่ง Content-Length -1 ออกไปจะมีปัญหากับบาง server ที่มองว่ามี Body ไม่ตรงกับ Content-Length แล้วจะตอบกลับมาด้วย 400 Bad Request</p>
    <p>วิธีแก้คือ ถ้ามีความจำเป็นต้องกำหนดค่า Body เองโดยไม่ผ่าน NewRequest อย่าลืมกำหนด ContentLength ไปด้วยเช่นกรณีนี้ก็ทำได้ง่ายๆคือ</p>
    <pre><code>package main

import (
	&quot;io&quot;
	&quot;io/ioutil&quot;
	&quot;log&quot;
	&quot;net/http&quot;
	&quot;os&quot;
	&quot;strings&quot;
)

func main() {
	r, err := http.NewRequest(&quot;POST&quot;, &quot;https://httpbin.org/delay/1&quot;, nil)
	if err != nil {
		log.Fatal(err)
	}
	buf := strings.NewReader(`{&quot;say&quot;: &quot;Hello, World&quot;}`)
	r.Body = ioutil.NopCloser(buf)
	r.ContentLength = int64(buf.Len())
	resp, err := http.DefaultClient.Do(r)
	if err != nil {
		log.Fatal(err)
	}
	io.Copy(os.Stdout, resp.Body)
}</code></pre>
    <footer>
      <p>วันที่ <span>2019-06-13 18:38:36</span></p>
      <a href="index.html">Index</a>
    </footer>
  </body>
</html>
